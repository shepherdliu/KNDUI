## <span id="menu">menu</span>

- 功能
    - 自定义界面菜单
- 参数
    - 菜单名称
    - Action菜单动作：[示教绝对](#teach_abs)/[示教机床](#teach_machine)/[示教表达式](#teach_expression)/[测量](#measure)/[加输入](#add_input)/[部分表达式](#part_expression)/[表达式](#expression)/[页面跳转](#goto_page)/[页面选择](#select_page)/[工件坐标](#work_coor)/[信号翻转](#signal_overturn)/[生成程序](#gen_prog)
    - enable表达式：当该表达式值不为0时，菜单才显示深色(可以响应按键)否则显示灰色(不响应按键)，不设置enable则无影响
- 语法与功能详解
下面1~6号菜单与teach控件联合使用
<span id="teach_abs">1. 示教绝对</span>：单轴示教时直接写入"示教绝对"，当光标停留在示教坐标数据的teach控件上时，菜单显示深色(可以响应按键)，按下菜单时执行示教绝对坐标的动作。示教轴组时写入"示教绝对(group=x)"，x为相应的轴组号。
```python
teach("#530", "X", (4, 1), group=2)
teach("#531", "Y", (4, 2))
teach("#533", "Z", (4, 3), group=2) 
menu("示教组2", 示教绝对(group=2) #光标停留在1/3行对应的控件上时，此菜单可以响应按键。键按下时同时将#530和#533赋值为X/Z轴的绝对坐标值
menu("示教", 示教绝对)  #光标停留在以上任意一个控件上时，此菜单可以响应按键。键按下时执行相应控件的示教绝对坐标动作
```
<span id="teach_machine">2. 示教机床</span>：单轴示教时直接写入"示教机床"，当光标停留在示教坐标数据的teach控件上时，菜单显示深色(可以响应按键)，按下菜单时执行示教机床坐标的动作。示教轴组时写入"示教机床(group=x)"，x为相应的轴组号。
```python
teach("#530", "X", (4, 1), group=2)
teach("#531", "Y", (4, 2))
teach("#533", "Z", (4, 3), group=2) 
menu("示教组2", 示教机床(group=2) #光标停留在1/3行对应的控件上时，此菜单可以响应按键。键按下时同时将#530和#533赋值为X/Z轴的机床坐标值
menu("示教", 示教机床)  #光标停留在以上任意一个控件上时，此菜单可以响应按键。键按下时执行相应控件的示教机床坐标动作
```
<span id="teach_expression">3. 示教表达式</span>：示教单个表达式时直接写入"示教表达式"，当光标停留在示教表达式的teach控件上时，菜单显示深色(可以响应按键)，按下菜单时执行示教表达式的动作。示教表达式组时写入"示教表达式(group=x)"，x为相应的表达式组号。
```python
teach("#530", "F156[s16]/100", (4, 1), group=2)
teach("#531", "F1805[u32]/1000", (4, 2))
teach("#533", "P414", (4, 3), group=2) 
menu("示教组2", 示教表达式(group=2) #光标停留在1/3行对应的控件上时，此菜单可以响应按键。键按下时同时将#530和#533赋值为对应表达式的计算结果
menu("示教", 示教表达式)  #光标停留在以上任意一个控件上时，此菜单可以响应按键。键按下时计算表达式的值赋给宏变量
```
<span id="menuTeach">在以下3个菜单</span>中定义2个变量$m和$v。$v为当前捕获光标的示教控件的编辑值，$m与$v的关系由菜单的类型决定。$m要用在teach控件的第二个参数中组成表达式，以实现通过编辑值改变控件值的目的。由于需要使用编辑值所以菜单要在控件有编辑值时才能响应按键。下图中的左侧图片显示data控件捕获光标，teach控件未捕获光标时的状态，此时底部的"测量"菜单不可用；右侧图片显示teach控件捕获光标并手动输入编辑值10的状态，此时$v的值为编辑值10，底部的"测量"菜单可以响应按键操作
3个菜单的典型用法是和形如teach("#530", "#530 + $m", (4, 1))的teach控件一起使用，第二个参数的形式不仅限于此，下面以这种形式为例讲解菜单的用法

<img src="pictures\menuTeach控件使用1.BMP"  width="410" />   <img src="pictures\menuTeach控件使用2.BMP"  width="410" />

<span id="measure">4. 测量</span>：在测量菜单中$m= -$v，对于上面的形式按下菜单键时将当前控件值减去控件的编辑值作为控件的新值，类似测量功能

```python
teach("#530", "#530 + $m", (4, 1))
menu("测量", 测量) #菜单名称为"测量"，当光标停留在上面的teach控件上，并输入了编辑值10时此菜单可以响应按键。键按下时相当于执行#530=#530-10
```
<span id="add_input">5. 加输入</span>：在加输入菜单中$m= $v，对于上面的形式按下菜单键时将当前控件值加上控件的编辑值作为控件的新值，类似 "+输入" 功能
```python
teach("#530", "#530 + $m", (4, 1))
menu("+输入", 加输入) #菜单名称为"+输入"，当光标停留在上面的teach控件上，并输入了编辑值10时此菜单可以响应按键。键按下时相当于执行#530=#530+10
```
<span id="part_expression">6. 部分表达式</span>：在部分表达式中$m和$v的关系由表达式决定，$m="表达式"，对于上面的形式按下菜单键时将当前控件值加上表达式计算结果值作为控件的新值
```python
teach("#530", "#530 + $m", (4, 1))
menu("测试", 部分表达式("$v - 3")) #菜单名称为"测试"，当光标停留在上面的teach控件上，并输入了编辑值10时此菜单可以响应按键。键按下时相当于执行#530=#530+10-3
```
<span id="expression">7. 表达式</span>：参数形式为：表达式(xxx)，xxx是一个赋值表达式，如"#500=#501+1"
```python
teach("表达式", 表达式("#500=#501+1"))  #菜单名称为"表达式"，键按下时执行赋值动作
```
<span id="goto_page">8. 页面跳转</span>：直接写入要跳转到的页面id，按菜单时会跳转到相应页面
```python
with page(5, 4, id="page1"):
	······
	
with page(5, 4, id="page2"):
	······
    menu("切换page1"，"page1") #菜单名称为"切换page1"，键按下时切换到id="page1"的页面

```
<span id="select_page">9. 页面选择</span>：可以根据某一PLC参数的值跳转到相应页面。语法举例：页面选择("K100",("page1", "page2", "page3"))。当K100(此处仅支持PLC参数)的值为0/1/2时分别跳转到id为page1/page2/page3的页面。此时PLC参数类型为U8，页面最多不要超过64个。当PLC参数的值不对应任何id时将跳转到第一个id对应的页面

```python
with page(5, 4, id="page1"):
	······
	
with page(5, 4, id="page2"):
	······

with page(5, 4, id="page3"):
	······
	
with page(5, 4, id="page4"):
	······
menu("页面选择"，页面选择("K100",("page1", "page2", "page3"))  #菜单名称为"页面选择"，当K100(此处仅支持PLC参数)的值为0/1/2时分别跳转到id为page1/page2/page3的页面
```
<span id="work_coor">10. 工件坐标</span>： 切换到相应的工件坐标系。语法举例：工件坐标("G55")
```python
menu("切换G55", 工件坐标("G55")) #菜单名称为"切换G55"，键按下时执行切换到工件坐标系G55的操作
```
<span id="signal_overturn">11. 信号翻转</span>：将相应地址的位信号翻转(在0/1之间转换)，支持的数据与[switch控件](switch.html)相同
```python
menu("翻转", 信号翻转("F5231.1")) #菜单名称为"翻转"，键按下时将F5231.1翻转
```
<span id="gen_prog">12. 生成程序</span>：第一个参数为程序模板文件名称（同一路径下），第二个参数为生成的程序号。生成程序时要打开程序开关，否则生成程序失败。在点击"生成程序"时程序模板文件中使用到的变量要有值，否则会报错。
- 应用分析与举例：
此菜单可根据程序模板一键生成程序。适用于要实现某一特定功能，但是程序中的某些参数需要频繁更改或在操作时才能确定的情况。
例如，要实现在一个圆周上钻孔的特定功能，同时使操作者可以设定圆心位置、圆周半径、圆的数量、钻孔深度、主轴转速、加工方式等参数。
首先将这些可变的参数设定为KUI脚本的变量；然后将这些变量设定为data控件或teach控件的数据显示在页面上，使操作者可以编辑；最后根据这些变量和要实现的功能写一个符合[KUI脚本语法](../KUI脚本语法.html)的程序模板文件。下图展示了实现上述功能的自定义界面。

<img src="pictures\生成程序举例.BMP" alt="新建工程" style="zoom:80%;" />

```python
#此处仅写出必要的代码
with page(510, 792, id="主页面"):
    picture("圆周钻孔.bmp", (1, 1, 510, 792))
    teach("{v500}", "x", (50, 654, 30, 96), f20x10, group=1)#圆心点X轴坐标
    teach("{v501}", "y", (90, 654, 30, 96), f20x10, group=1)#圆心点Y轴坐标
    data("{v502}", (130, 654, 30, 96), 确认)                #圆周半径
    data("{v503}", (170, 654, 30, 96), f20x10, 确认)        #圆周上孔的数量
    data("{v504}", (210, 654, 30, 96), 确认)                #第一个孔的角度
    data("{v505}", (250, 654, 30, 96), 确认)                #深度
    data("{v506}", (290, 654, 30, 96), choices={81: "G81", 82: "G82", 83: "G83"})      #G81-82-83
    data("{v507}", (330, 654, 30, 96), 确认)   #主轴转速
    data("{v508}", (370, 654, 30, 96), 确认)   #R点距离
    data("{v509}", (410, 654, 30, 96), 确认)   #钻孔速度
    data("{v510}", (450, 654, 30, 96), 确认)   #孔间断Q值

    menu("生成程序", 生成程序("圆周钻孔.txt", 1))#菜单名称为"生成程序"，程序模板"圆周钻孔.txt"在当前目录下。在系统端按下此菜单时将执行程序模板生成程序"O0001.PRG"
    menu("示教坐标", 示教绝对(group=1))   #此处用了示教组功能，将X/Y轴的绝对坐标同时读入v500和v501中
    
#以下为程序模板"圆周钻孔.txt"的内容：
G17 G90 G49 G80 G40
G91 G28 Z0
G90 M03 S#v507
M08
#v521 = #v503 - 1
FOR #i=0 TO #v521 DO;       //FOR循环
    #v10 = #v500 + #v502 * COS[[#v504 + #i * 360.0 / #v503]*PI/180]
    #v20 = #v501 + #v502 * SIN[[#v504 + #i * 360.0 / #v503]*PI/180]
    IF #v506 == 81 THEN;    //IF语句
        G81 K0 X#v10 Y#v20 Z#v505 R#v508 F#v509;
    ELSEIF #v506 == 82 THEN;
        G82 K0 X#v10 Y#v20 Z#v505 R#v508 Q#v510 F#v509;
    ELSEIF #v506 == 83 THEN;
         G83 K0 X#v10 Y#v20 Z#v505 R#v508 Q#v510 F#v509;
    ENDIF
ENDFOR
M05
M09
M30
```